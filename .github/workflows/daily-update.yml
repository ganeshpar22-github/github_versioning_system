name: Daily Version Generation and Deploy

on:
  schedule:
    # Runs every day at 00:05 UTC
    - cron: '5 0 * * *'
  push:
    branches:
      - master   #here we have to change name to main
  workflow_dispatch: # Allows manual triggering from the GitHub UI

jobs:
  generate-version:
    name: Build and Validate versions
    runs-on: ubuntu-latest
    # Grant necessary permissions for checkout, writing files, and deploying pages
    permissions:
      contents: write 
    
    steps:
      - name: Checkout Repository (Fetch all branches)
        uses: actions/checkout@v4
        with:
          # Fetch depth 0 ensures we have all branches locally for the script to switch between them
          fetch-depth: 0 
          ref: master   #here we have to change name to main

      
      
       
      - name: Install Dependencies
        run: |
          # Install jq for JSON validation as requested in the utility script
          sudo apt-get update && sudo apt-get install -y jq

      - name: Make scripts executable
        # Ensure both the main orchestrator and the individual version scripts are executable
        run: |
          chmod +x scripts/utilityscript.sh
          # Since utilityscript.sh checks out other branches, this might be redundant, 
          # but good practice if testing locally. The chmod on the main script is crucial.

      - name: Run Version Generation Utility Script
        # This script orchestrates the whole process, including calling version.sh on all branches
        run: ./scripts/utilityscript.sh
        # If utilityscript.sh exits with a non-zero status (due to 'set -e' on errors), 
        # this step fails the workflow as required by the epic.

      - name: Run Validation Script
        # This satisfies Requirement 3: Pipeline fails if validation fails
        run: |
          chmod +x scripts/output_validation.sh
          ./scripts/output_validation.sh

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Directory containing the generated HTML and JSON files
          path: 'site_output'
          retention-days: 7

  publish-pages:
    name: Publish Generated Versions to GitHub Pages
    needs: generate-version
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      
      

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
